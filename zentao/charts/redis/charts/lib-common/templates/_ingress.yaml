{{- define "lib-common.ingress.host" -}}
{{- $host := default .Values.ingress.host .Values.global.ingress.host -}}
{{- tpl $host . -}}
{{- end -}}

{{- define "lib-common.ingress.host.v2" -}}
{{- $host := default .values.ingress.host .values.global.ingress.host -}}
{{- tpl $host .ctx -}}
{{- end -}}

{{/*
generate ingress resource
Usage:
{{ include "lib-common.ingress.tpl" (dict "uniqueSuffix" $name "opts" "opts" "host" "host" "tls" "tls" "class" "class" "ctx" $) }}
*/}}
{{- define "lib-common.ingress.tpl" -}}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ if .uniqueSuffix }}{{ printf "%s-%s" (include "lib-common.name.fullname" .ctx) (toString .uniqueSuffix) }}{{ else }}{{ template "lib-common.name.fullname" .ctx }}{{ end }}
  namespace: {{ .ctx.Release.Namespace | quote }}
  labels: {{- include "lib-common.labels.standard" .ctx | nindent 4 }}
  {{- if .opts.annotations }}
  annotations:
  {{- include "lib-common.annotations" (dict "annotations" .opts.annotations "ctx" .ctx) | indent 4}}
  {{- end }}
spec:
  {{- if eq "true" (include "lib-common.ingress.supportsIngressClassname" .ctx ) }}
  ingressClassName: {{ default .opts.ingressClassName .ctx.Values.global.ingress.className }}
  {{- end }}
  rules:
  - host: {{ .host }}
    http:
      paths:
      {{- range .opts.paths }}
      - backend:
          service:
            name: {{ template "lib-common.name.fullname" $.ctx }}
            port:
              number: {{ .port }}
        path: {{ .path }}
        pathType: {{ default "Prefix" .type }}
      {{- end }}
  {{- if and .tls.enabled }}
  tls:
    - hosts:
        - {{ .host }}
      secretName: {{ .tls.secretName }}
  {{- end }}
{{ "" }}
{{- end }}


{{- define "lib-common.ingress" -}}
{{- include "lib-common.util.mergeValues" (list . "lib-common") -}}
{{- if not (or .Values.global.stoped .Values.global.stopped) }}
{{- if .Values.ingress.enabled }}
{{- include "lib-common.ingress.tpl" (dict 
  "opts" .Values.ingress
  "host" (include "lib-common.ingress.host" .)
  "tls" .Values.ingress.tls
  "class" .Values.ingress.ingressClassName
  "ctx" .) }}
{{- end }}
{{- end }}
{{- end -}}

{{- define "lib-common.ingress.v2" -}}
{{- include "lib-common.values.merge" . -}}
{{- $values := default .Values .Component.Values -}}
{{- if not (or .Values.global.stoped .Values.global.stopped) }}
{{- if and (or $values.ingress.enabled $values.global.ingress.enabled) $values.ingress.paths }}
{{- include "lib-common.ingress.tpl" (dict 
  "opts" $values.ingress
  "host" (include "lib-common.ingress.host.v2" (dict "values" $values "ctx" .))
  "tls" $values.ingress.tls
  "class" $values.ingress.ingressClassName
  "ctx" .) }}
{{- end }}
{{- end }}
{{- end -}}
